<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Fun with jq | Gustavo&#39;s blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="What is jq? jq is a wonderful tool for processing JSON in the command line. The prevalence of JSON in web APIs and data dumps makes jq a very imporant tool for interactively manipulating JSON. The tutorial is good enough to get you started with basic functionality, but I found that real usage quickly outgrew the scope of the tutorial. In this post I will show examples of using jq in slightly more complex scenarios than the tutorial.">
    <meta name="generator" content="Hugo 0.102.3" />
    
    
    
    
      <meta name="robots" content="noindex, nofollow">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.css" >



    
    
    
      

    

    
    
    <meta property="og:title" content="Fun with jq" />
<meta property="og:description" content="What is jq? jq is a wonderful tool for processing JSON in the command line. The prevalence of JSON in web APIs and data dumps makes jq a very imporant tool for interactively manipulating JSON. The tutorial is good enough to get you started with basic functionality, but I found that real usage quickly outgrew the scope of the tutorial. In this post I will show examples of using jq in slightly more complex scenarios than the tutorial." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://gustavohidalgo.com/posts/2021-07-24-fun-with-jq/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-24T12:34:23-04:00" />
<meta property="article:modified_time" content="2021-07-24T12:34:23-04:00" />

<meta itemprop="name" content="Fun with jq">
<meta itemprop="description" content="What is jq? jq is a wonderful tool for processing JSON in the command line. The prevalence of JSON in web APIs and data dumps makes jq a very imporant tool for interactively manipulating JSON. The tutorial is good enough to get you started with basic functionality, but I found that real usage quickly outgrew the scope of the tutorial. In this post I will show examples of using jq in slightly more complex scenarios than the tutorial."><meta itemprop="datePublished" content="2021-07-24T12:34:23-04:00" />
<meta itemprop="dateModified" content="2021-07-24T12:34:23-04:00" />
<meta itemprop="wordCount" content="893">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fun with jq"/>
<meta name="twitter:description" content="What is jq? jq is a wonderful tool for processing JSON in the command line. The prevalence of JSON in web APIs and data dumps makes jq a very imporant tool for interactively manipulating JSON. The tutorial is good enough to get you started with basic functionality, but I found that real usage quickly outgrew the scope of the tutorial. In this post I will show examples of using jq in slightly more complex scenarios than the tutorial."/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Gustavo&#39;s blog
      
    </a>
    <div class="flex-l items-center">
      

      
      
<div class="ananke-socials">
  
</div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        POSTS
      </aside>
      










  <div id="sharing" class="mt3 ananke-socials">
    
  </div>


      <h1 class="f1 athelas mt3 mb1">Fun with jq</h1>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-07-24T12:34:23-04:00">July 24, 2021</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h1 id="what-is-jq">What is <code>jq</code>?</h1>
<p><a href="https://stedolan.github.io/jq/tutorial/"><code>jq</code></a> is a wonderful tool for processing JSON in the command line.
The prevalence of JSON in web APIs and data dumps makes <code>jq</code> a very imporant tool for interactively manipulating JSON.
The <a href="https://stedolan.github.io/jq/tutorial/">tutorial</a> is good enough to get you started with basic functionality, but I found that real usage quickly outgrew the scope of the tutorial.
In this post I will show examples of using <code>jq</code> in slightly more complex scenarios than the tutorial.</p>
<p>The data in this post comes from <a href="https://www.yelp.com/dataset/documentation/main">Yelp&rsquo;s Dataset Challenge</a>, and I will be focusing on the business data file (that is <code>yelp_academic_dataset_business.json</code> if you&rsquo;re following at home).</p>
<h1 id="formatting">Formatting</h1>
<p>Usually I like to look at one row of a dataset to understand the data schema.
The Yelp data contains one entry per line, so we can use <code>head -n 1</code> argument to get the first line of the data file and inspect the schema.</p>
<pre tabindex="0"><code>&gt; head -n1 yelp_academic_dataset_business.json 
{&#34;business_id&#34;:&#34;6iYb2HFDywm3zjuRg0shjw&#34;,&#34;name&#34;:&#34;Oskar Blues Taproom&#34;,&#34;address&#34;:&#34;921 Pearl St&#34;,&#34;city&#34;:&#34;Boulder&#34;,&#34;state&#34;:&#34;CO&#34;,&#34;postal_code&#34;:&#34;80302&#34;,&#34;latitude&#34;:40.0175444,&#34;longitude&#34;:-105.2833481,&#34;stars&#34;:4.0,&#34;review_count&#34;:86,&#34;is_open&#34;:1,&#34;attributes&#34;:{&#34;RestaurantsTableService&#34;:&#34;True&#34;,&#34;WiFi&#34;:&#34;u&#39;free&#39;&#34;,&#34;BikeParking&#34;:&#34;True&#34;,&#34;BusinessParking&#34;:&#34;{&#39;garage&#39;: False, &#39;street&#39;: True, &#39;validated&#39;: False, &#39;lot&#39;: False, &#39;valet&#39;: False}&#34;,&#34;BusinessAcceptsCreditCards&#34;:&#34;True&#34;,&#34;RestaurantsReservations&#34;:&#34;False&#34;,&#34;WheelchairAccessible&#34;:&#34;True&#34;,&#34;Caters&#34;:&#34;True&#34;,&#34;OutdoorSeating&#34;:&#34;True&#34;,&#34;RestaurantsGoodForGroups&#34;:&#34;True&#34;,&#34;HappyHour&#34;:&#34;True&#34;,&#34;BusinessAcceptsBitcoin&#34;:&#34;False&#34;,&#34;RestaurantsPriceRange2&#34;:&#34;2&#34;,&#34;Ambience&#34;:&#34;{&#39;touristy&#39;: False, &#39;hipster&#39;: False, &#39;romantic&#39;: False, &#39;divey&#39;: False, &#39;intimate&#39;: False, &#39;trendy&#39;: False, &#39;upscale&#39;: False, &#39;classy&#39;: False, &#39;casual&#39;: True}&#34;,&#34;HasTV&#34;:&#34;True&#34;,&#34;Alcohol&#34;:&#34;&#39;beer_and_wine&#39;&#34;,&#34;GoodForMeal&#34;:&#34;{&#39;dessert&#39;: False, &#39;latenight&#39;: False, &#39;lunch&#39;: False, &#39;dinner&#39;: False, &#39;brunch&#39;: False, &#39;breakfast&#39;: False}&#34;,&#34;DogsAllowed&#34;:&#34;False&#34;,&#34;RestaurantsTakeOut&#34;:&#34;True&#34;,&#34;NoiseLevel&#34;:&#34;u&#39;average&#39;&#34;,&#34;RestaurantsAttire&#34;:&#34;&#39;casual&#39;&#34;,&#34;RestaurantsDelivery&#34;:&#34;None&#34;},&#34;categories&#34;:&#34;Gastropubs, Food, Beer Gardens, Restaurants, Bars, American (Traditional), Beer Bar, Nightlife, Breweries&#34;,&#34;hours&#34;:{&#34;Monday&#34;:&#34;11:0-23:0&#34;,&#34;Tuesday&#34;:&#34;11:0-23:0&#34;,&#34;Wednesday&#34;:&#34;11:0-23:0&#34;,&#34;Thursday&#34;:&#34;11:0-23:0&#34;,&#34;Friday&#34;:&#34;11:0-23:0&#34;,&#34;Saturday&#34;:&#34;11:0-23:0&#34;,&#34;Sunday&#34;:&#34;11:0-23:0&#34;}}
</code></pre><p>ðŸ˜… A little hard to read. Let&rsquo;s pipe that into <code>jq</code></p>
<pre tabindex="0"><code>&gt; head -n1 yelp_academic_dataset_business.json | jq
{
  &#34;business_id&#34;: &#34;6iYb2HFDywm3zjuRg0shjw&#34;,
  &#34;name&#34;: &#34;Oskar Blues Taproom&#34;,
  &#34;address&#34;: &#34;921 Pearl St&#34;,
  &#34;city&#34;: &#34;Boulder&#34;,
  &#34;state&#34;: &#34;CO&#34;,
  &#34;postal_code&#34;: &#34;80302&#34;,
  &#34;latitude&#34;: 40.0175444,
  &#34;longitude&#34;: -105.2833481,
  &#34;stars&#34;: 4,
  &#34;review_count&#34;: 86,
  &#34;is_open&#34;: 1,
  &#34;attributes&#34;: {
    &#34;RestaurantsTableService&#34;: &#34;True&#34;,
    &#34;WiFi&#34;: &#34;u&#39;free&#39;&#34;,
    &#34;BikeParking&#34;: &#34;True&#34;,
    &#34;BusinessParking&#34;: &#34;{&#39;garage&#39;: False, &#39;street&#39;: True, &#39;validated&#39;: False, &#39;lot&#39;: False, &#39;valet&#39;: False}&#34;,
    &#34;BusinessAcceptsCreditCards&#34;: &#34;True&#34;,
    &#34;RestaurantsReservations&#34;: &#34;False&#34;,
    &#34;WheelchairAccessible&#34;: &#34;True&#34;,
    &#34;Caters&#34;: &#34;True&#34;,
    &#34;OutdoorSeating&#34;: &#34;True&#34;,
    &#34;RestaurantsGoodForGroups&#34;: &#34;True&#34;,
    &#34;HappyHour&#34;: &#34;True&#34;,
    &#34;BusinessAcceptsBitcoin&#34;: &#34;False&#34;,
    &#34;RestaurantsPriceRange2&#34;: &#34;2&#34;,
    &#34;Ambience&#34;: &#34;{&#39;touristy&#39;: False, &#39;hipster&#39;: False, &#39;romantic&#39;: False, &#39;divey&#39;: False, &#39;intimate&#39;: False, &#39;trendy&#39;: False, &#39;upscale&#39;: False, &#39;classy&#39;: False, &#39;casual&#39;: True}&#34;,
    &#34;HasTV&#34;: &#34;True&#34;,
    &#34;Alcohol&#34;: &#34;&#39;beer_and_wine&#39;&#34;,
    &#34;GoodForMeal&#34;: &#34;{&#39;dessert&#39;: False, &#39;latenight&#39;: False, &#39;lunch&#39;: False, &#39;dinner&#39;: False, &#39;brunch&#39;: False, &#39;breakfast&#39;: False}&#34;,
    &#34;DogsAllowed&#34;: &#34;False&#34;,
    &#34;RestaurantsTakeOut&#34;: &#34;True&#34;,
    &#34;NoiseLevel&#34;: &#34;u&#39;average&#39;&#34;,
    &#34;RestaurantsAttire&#34;: &#34;&#39;casual&#39;&#34;,
    &#34;RestaurantsDelivery&#34;: &#34;None&#34;
  },
  &#34;categories&#34;: &#34;Gastropubs, Food, Beer Gardens, Restaurants, Bars, American (Traditional), Beer Bar, Nightlife, Breweries&#34;,
  &#34;hours&#34;: {
    &#34;Monday&#34;: &#34;11:0-23:0&#34;,
    &#34;Tuesday&#34;: &#34;11:0-23:0&#34;,
    &#34;Wednesday&#34;: &#34;11:0-23:0&#34;,
    &#34;Thursday&#34;: &#34;11:0-23:0&#34;,
    &#34;Friday&#34;: &#34;11:0-23:0&#34;,
    &#34;Saturday&#34;: &#34;11:0-23:0&#34;,
    &#34;Sunday&#34;: &#34;11:0-23:0&#34;
  }
}
</code></pre><p>Much easier to read!</p>
<h2 id="format-the-whole-file">Format the whole file</h2>
<p>To completely format a file, we can pipe all lines into <code>jq</code> and then redirect the result to a file:</p>
<pre tabindex="0"><code>&gt; cat yelp_academic_dataset_business.json | jq &gt; yelp_academic_dataset_business_formatted.json
</code></pre><blockquote>
<p>Caution, this file is not valid JSON! It is only useful for reading through the data in a text editor.</p>
</blockquote>
<h1 id="filtering">Filtering</h1>
<p>Let&rsquo;s say we wanted to find all of the restaurants with ratings &gt;= 4 and with more than 5 reviews.
We can do it like this:</p>
<pre tabindex="0"><code>&gt; cat yelp_academic_dataset_business.json | jq --compact-output &#39;select(.review_count &gt; 5 and .stars &gt;= 4)&#39; &gt; high_ratings.json
</code></pre><blockquote>
<p>Note that I used <code>--compact-output</code> to preserve the 1-object-per-line structure of the original file. Without this option, <code>high_ratings.json</code> would contain nicely formatted JSON.</p>
</blockquote>
<p>The syntax is very easy: <code>jq 'select(&lt;boolean expression&gt;)'</code> will filter objects where the boolean expression returns false.</p>
<h1 id="selecting">Selecting</h1>
<p>Or sometimes called projections, I will show 2 cases building on the previous filter example.</p>
<h2 id="select-json-to-value">Select JSON to value</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>cat yelp_academic_dataset_business.json | jq --compact-output <span style="color:#e6db74">&#39;select(.review_count &gt; 5 and .stars &gt;= 4) | .business_id&#39;</span> &gt; high_ratings.json
</span></span></code></pre></div><p>After the <code>select</code> call, I pipe the resulting object into a property access <code>.business_id</code>.
This produces a file that looks like:</p>
<pre tabindex="0"><code>&#34;6iYb2HFDywm3zjuRg0shjw&#34;
&#34;tCbdrRPZA0oiIYSmHG3J0w&#34;
&#34;bvN78flM8NLprQ1a1y5dRg&#34;
&#34;PE9uqAjdw0E4-8mjGl3wVA&#34;
</code></pre><h2 id="select-json-to-json">Select JSON to JSON</h2>
<pre tabindex="0"><code>cat yelp_academic_dataset_business.json | jq --compact-output &#39;select(.review_count &gt; 5 and .stars &gt;= 4) | {business_id}&#39; &gt; high_ratings.json
</code></pre><p>Note that the syntax <code>| {business_id}</code> is a shortcut for <code>| {&quot;business_id&quot;: .business_id}</code>, the latter case can be useful if you want to rename a property or product a new property from different values.
This produces a file that looks like:</p>
<pre tabindex="0"><code>{&#34;business_id&#34;:&#34;6iYb2HFDywm3zjuRg0shjw&#34;}
{&#34;business_id&#34;:&#34;tCbdrRPZA0oiIYSmHG3J0w&#34;}
{&#34;business_id&#34;:&#34;bvN78flM8NLprQ1a1y5dRg&#34;}
{&#34;business_id&#34;:&#34;PE9uqAjdw0E4-8mjGl3wVA&#34;}
</code></pre><h1 id="json-to-ctsv">JSON to [C|T]SV</h1>
<p>JSON is a very self-documenting format for data, which is great for humans but not very useful for computers.
If I wanted to do some basic analysis on this data, the first thing I would do is load it into a spreadsheet program and start generating some graphs.
To do that, we need to transform this file into a comma-separated value file or a tab-separated value file.</p>
<p>Unfortunately any command to transform JSON to CSV on anything but the most basic JSON has to make choices about what to do with object and array properties (recursively) so there is no easy answer.
The <code>jq</code> filter we write depends on the source data and how we want the CSV to look like.</p>
<p>Or does it?
Denizens of the internet have graciously provided a <code>jq</code> filter to perform this for arbitrary JSON.
This filter takes advantage of <code>jq</code>&rsquo;s programming features: that&rsquo;s right, <code>jq</code> is its own little programming language!
Gaze your eyes on this:</p>
<pre tabindex="0"><code>def json2header:
  [paths(scalars)];

def json2array($header):
  [$header[] as $p | getpath($p)];

# given an array of conformal objects, produce &#34;CSV&#34; rows, with a header row:
def json2csv:
  (.[0] | json2header) as $h
  | ([$h[]|join(&#34;.&#34;)], (.[] | json2array($h))) 
  | @csv ;

# `main`
json2csv
</code></pre><p>Put this into a file called <code>json2csv.jq</code> and invoke it like this:</p>
<pre tabindex="0"><code>jq -rf json2csv.jq yelp_academic_dataset_business.json
</code></pre><p>Don&rsquo;t forget to turn the json file into an array of objects first with something like:</p>
<pre tabindex="0"><code>&gt; head -n 3 yelp_academic_dataset_business.json | jq -s &#39;.&#39; &gt; high_ratings.json
</code></pre><p>Big thanks to <a href="https://stackoverflow.com/questions/32960857/how-to-convert-arbitrary-simple-json-to-csv-using-jq">this</a> and <a href="https://stackoverflow.com/questions/57242240/jq-object-cannot-be-csv-formatted-only-array">this</a> StackOverflow question.</p>
<h1 id="conclusion">Conclusion</h1>
<p><code>jq</code> is great!</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://gustavohidalgo.com/" >
    &copy;  Gustavo's blog 2022 
  </a>
    <div>
<div class="ananke-socials">
  
</div>
</div>
  </div>
</footer>

  </body>
</html>
